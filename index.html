<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <title>Traditional Practices for Policy in Kyrgyzstan</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.44.1/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.44.1/mapbox-gl.css' rel='stylesheet' />
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script src='//api.tiles.mapbox.com/mapbox.js/plugins/turf/v2.0.0/turf.min.js' charset='utf-8'></script>
    <script src="https://npmcdn.com/@turf/turf/turf.min.js"></script>
    <script src='//d3js.org/d3.v4.min.js' charset='utf-8'></script>
    <link rel="stylesheet" type="text/css" href="https://rawgit.com/NUKnightLab/juxtapose/1.1.3/juxtapose/css/juxtapose.css">
    <!--<link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.5.2/animate.min.css">-->
    
    

    <style>
      body { margin:0; padding:0; }
      #map { position:absolute; top:0; width:100%; height:100%;}
      .mapboxgl-popup { max-width: 30%; font: 16px 'Roboto Condensed', sans-serif;}
    	.settings{
    	position:absolute;
    	right:0px;
    	top:5px;
    	right:10px;
    	width:10%;
    	border-radius: 3px;
    	}
    	#buttons {position:relative;left:0px;top:0px;}
    	.button {
        display: inline-block;
        position: relative;
        cursor: pointer;
        padding: 8px;
        border-radius: 3px;
        margin: 5px;
        font-size: 12px;
        text-align: center;
        color: #fff;
        background: #ee8a65;
        font-family: sans-serif;
        font-weight: bold;    
    	}
      #features-all {
        position: absolute;
        top:0;
        bottom: 0;
        left: 0;
        width: 25%;
        height:100%;
        color:black;
        border-radius: 3px;
        background:white;
        font-family: Roboto Condensed, sans-serif;
        font-size:16px;
        overflow:auto;
      }
      #feature-title {
      position:relative;
      padding:5px;
      padding-left:10px;
      margin-left: 5px;
      margin-top: 2px;
      margin-bottom: 2px;
      margin-right: 5px;
      font-weight: bold; 
      color: red;
      font-size:20px;
      }
      #feature-photo{
        position: relative;
        height: 33%;
        max-height:33%;
      }
      #feature-photo img{
        max-width:100%;
        max-height:100%;
        object-fit:contain;
        display: block;
        margin: 0 auto;
      }
      #feature-content{
      position:relative;
      margin:5px 15px 5px 10px;
      text-align:left;
      }
      #previous {
      display:inline-block;
        position: relative;
        cursor: pointer;
        bottom:0;
        left:0;
        padding:20px;
        text-align: center;
        width:40%;
      }
      #pageindex {
      display:inline-block;
        position: relative;
        padding:5px;
        bottom:0;
        font-size: 12px;
        font-weight: bold;
        text-align: center;
        width:10%;
      }
      #next {
        display:inline-block;
        position: relative;
        cursor: pointer;
        padding:20px;
        bottom:0;
        right:0;
        text-align: center;
        width:40%;
      }

    	.legend {                                                   /* NEW */
        font-size: 2px;                                          /* NEW */
      }                                                           /* NEW */
      rect {                                                      /* NEW */
        stroke-width: 0.5;                                          /* NEW */
      }       
                                                          /* NEW */
      #legendcontainer {
      position:absolute;
      left:25%;
      top:0%;
      width:75%;
      color:black;
      font-family: Roboto Condensed, sans-serif;
      font-size: 16px;
      } 
      #fly{
      position: relative;
      width:10%;
      text-align: center;
      color: #fff;
      background: #3887be;
      border-radius: 3px;
      display:none;
      left:15px;
      top:15px;
      
      }
      #fly:hover{
      color: #fff;
      background: #3074a4;
      }
      #timeslider{
        padding-left: 15px;
        padding-top:15px;
        display:none;
      }
      #medplantwidget{
        width:75%;
        position:absolute;
        max-height:40%;
        bottom:0;
        left:25%;
        display:none;
      }
      #plantholder {padding-left: 10px;}
      #plantinfo{
       position:relative;
       background:white;
       width:100%; 

      }
      #plantinfo img {
        float:left;
        max-width:20%;
        position:relative;
        padding-right:5px;
        padding-top: 5px;
        padding-bottom: 5px;
        background:white;
      }
      .img-round{border-radius:50%;}
      .clearfix::after {
          content: "";
          clear: both;
          display: table;
      }
      #plantlatin{
        margin-left: 5px;
        margin-top: 2px;
        margin-bottom: 2px;
        margin-right: 5px;
        font-weight: bold;
        max-width:70%;
        position:relative;
      }
      #plantdescription{
        position:relative
        max-width:70%;
      }
      /* Tooltip container */
  .medplanttooltip {
      position: relative;
      display: inline-block;
      border-bottom: 1px dotted black;
      font-size:14px;
      color:grey;
  }

  /* ltip text */
  .medplanttooltip .medplanttooltiptext {
      visibility: hidden;
      width: 240px;
      background-color: #555;
      color: #fff;
      text-align: center;
      padding: 5px 0;
      border-radius: 6px;
      font-size:12px;

      /* Position the tooltip text */
      position: absolute;
      z-index: 1;
      bottom: 125%;
      left: 50%;
      margin-left: -120px;

      /* Fade in tooltip */
      opacity: 0;
      transition: opacity 0.3s;
  }

  /* Tooltip arrow */
  .medplanttooltip .medplanttooltiptext::after {
      content: "";
      position: absolute;
      top: 100%;
      left: 50%;
      margin-left: -5px;
      border-width: 5px;
      border-style: solid;
      border-color: #555 transparent transparent transparent;
  }

  /* Show the tooltip text when you mouse over the tooltip container */
  .medplanttooltip:hover .medplanttooltiptext {
      visibility: visible;
      opacity: 1;
  }
      #sdg17 {
        position: absolute;
        left: 40%;
        top: 25%;
        display:none;
      }
      #marker {
        background-image: url('/mapbox-gl-js/assets/washington-monument.jpg');
        background-size: cover;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        cursor: pointer;
      }
    	#menu {
        background: #b0c4dd;
        position: relative;
        z-index: 1;
        border-radius: 3px;
        font-family: Roboto Condensed, sans-serif;
   		 }
   		#menu a {
        font-size: 13px;
        color: #404040;
        display: block;
        margin: 0;
        padding: 10px;
        text-decoration: none;
        border-bottom: 1px solid rgba(0,0,0,0.25);
        text-align: center;
    	}
    	#menu a:last-child {border: none;}
    	#menu a:hover {background-color: #3074a4;color: #ffffff;}
    	#menu a.active {background-color: #3887be;color: #ffffff;}
    	#menu a.active:hover {background: #3074a4;}
      .feature-content:hover ~ #timeslider {
        background:red;
      }

      #slideout {
        position: absolute;
        top: 35%;
        left: 25%;
        width: 30px;
        padding: 4px;
        text-align: center;
        background: #3887be;
        display:none;
        color: #fff;
        font-family: Roboto Condensed, sans-serif;
        }
    .slideout-glow {
      box-shadow: 0px 0px 20px rgba(255, 187, 51, .7);
    }
    #slideout_inner {
        position: fixed;
        top: 40px;
        left: -35%;
        background: #3887be;
        width: 35%;
        padding: 5px;
        font-family: Roboto Condensed, sans-serif;
        border-radius: 0 0 5px 0;
    }
    #slideout:hover #slideout_inner {
        left: 25%;
        top:0px;
    }
    .sideways{
      writing-mode:vertical-rl;
      text-orientation: sideways;
    }
      #chart {                                                          /* NEW */
        height: 360px;                                                  
        position: relative;                                             
        width:360px;
        margin: 0 auto;                                               
      }                                                                
      .tooltip {                                                        /* NEW */
        background: #eee;                                              
        box-shadow: 0 0 5px #999999;                                   
        color: #333;                                                   
        display: none;                                                 
        font-size: 16px;
        font-family: Roboto Condensed, sans-serif;                                               
        left: 130px;                                                   
        padding: 10px;                                                  
        position: absolute;                                             
        text-align: center;                                             
        top: 95px;                                                      
        width: 80px;                                                    
        z-index: 10;                                                    
      }                                                                 
  .legend {
    font-size: 12px;
  }
  object {max-width:100%;}
  iframe {width:100%; height:100%; display:block;}
  #iframewrap {position:relative;max-width:100%; height:200px;}
  .youtubecontainer{position: relative;
    width: 100%;
    height: 0;
    padding-bottom: 56.25%;}
  .youtubevideo{position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;}
  rect {
    stroke-width: 2;
    cursor: pointer;                                              
  }
  rect.disabled {                                                 /* NEW */
        fill: transparent !important;                                 
      }                                                               
    h4{color:red;}
    li{opacity:0;
      border: solid 0.1em;}
    li a {
        color:white;
        display: block;
        background: #3887be;
        padding: 8px 16px;
        text-decoration: none;
        font-size: 16px;
        font-family: Roboto Condensed, sans-serif;
    }
    li a:hover {
        background-color: #3074a4;
        color: white;
    }

    /*Styling for time slider*/
    input[type=range] {
      height: 38px;
      -webkit-appearance: none;
      margin: 0;
      width: 15%;
      opacity: 0.7;
      background:#00000000;
    }
    input[type=range]:focus {
      outline: none;
    }
    input[type=range]::-webkit-slider-runnable-track {
      width: 100%;
      height: 10px;
      cursor: pointer;
      animate: 0.2s;
      box-shadow: 1px 1px 1px #000000;
      background: #3071A9;
      border-radius: 5px;
      border: 1px solid #000000;
    }
    input[type=range]::-webkit-slider-runnable-track:hover {
    	box-shadow:0px 0px 20px #2B547E;
    }

    input[type=range]::-webkit-slider-thumb {
      box-shadow: 1px 1px 1px #000000;
      border: 1px solid #000000;
      height: 25px;
      width: 7px;
      border-radius: 5px;
      background: #FFFFFF;
      cursor: pointer;
      -webkit-appearance: none;
      margin-top: -11px;
    }
    input[type=range]:focus::-webkit-slider-runnable-track {
      background: #3071A9;
    }
    input[type=range]::-moz-range-track {
      width: 100%;
      height: 10px;
      cursor: pointer;
      animate: 0.2s;
      box-shadow: 1px 1px 1px #000000;
      background: #3071A9;
      border-radius: 5px;
      border: 1px solid #000000;
    }
    input[type=range]::-moz-range-thumb {
      box-shadow: 1px 1px 1px #000000;
      border: 1px solid #000000;
      height: 30px;
      width: 15px;
      border-radius: 5px;
      background: #FFFFFF;
      cursor: pointer;
    }
    input[type=range]::-ms-track {
      width: 100%;
      height: 10px;
      cursor: pointer;
      animate: 0.2s;
      background: transparent;
      border-color: transparent;
      color: transparent;
    }
    input[type=range]::-ms-fill-lower {
      background: #3071A9;
      border: 1px solid #000000;
      border-radius: 10px;
      box-shadow: 1px 1px 1px #000000;
    }
    input[type=range]::-ms-fill-upper {
      background: #3071A9;
      border: 1px solid #000000;
      border-radius: 10px;
      box-shadow: 1px 1px 1px #000000;
    }
    input[type=range]::-ms-thumb {
      margin-top: 1px;
      box-shadow: 1px 1px 1px #000000;
      border: 1px solid #000000;
      height: 30px;
      width: 15px;
      border-radius: 5px;
      background: #FFFFFF;
      cursor: pointer;
    }
    input[type=range]:focus::-ms-fill-lower {
      background: #3071A9;
    }
    input[type=range]:focus::-ms-fill-upper {
      background: #3071A9;
    }
    .clearfix::after {
    content: "";
    clear: both;
    display: table;
}
    </style>
</head>
<body>
	
<div id='map'></div>
<div id="sdg17" >
  <ul>
    <li><a href = "http://www.stat.kg/en/" target="_blank">National Statistical Committee</a></li>
    <li><a href = "http://geonode.msri.io/" target="_blank">Geonode MSRI</a></li>
    <li><a href = "https://openstreetmap.org" target="_blank">Open Street Map</a></li>
    <li><a href = "http://www.kyrgyzstanspatial.org/" target="_blank">Kyrgyzstan Spatial</a></li>
    <li><a href = "http://wildlife.caiag.kg/drupal_wa/?q=en" target="_blank">Wild Animals</a></li>
    <li><a href = "http://www.osi-panthera.org/" target="_blank">OSI Panthera</a></li>
    <li><a href = "https://okmot.kg/" target="_blank">Information Resources of the Kyrgyz Republic</a></li>
    <li><a href = "https://data.srs.kg/" target="_blank">Election Analytic</a></li>
    <li><a href = "http://www.reach-initiative.kg/" target="_blank">Reach Initiative</a></li>
  </ul>
</div>
<div class='settings'>
	<ul id="buttons">
      <button type="button" class="btn btn-info btn-lg" data-toggle="modal" data-target="#myModal" style="font-family: Roboto Condensed, sans-serif;">About</button>
	</ul>
	<!--menu for layer switchers -->
	<nav id="menu"></nav>
</div>

<div id="features-all" class="relatedlead">
  	<div id='feature-photo'></div>
	<div id='feature-title'></div>
	<div id='feature-content'></div>  
	<div id='previous'><img src="./images/previous.png" style="max-width:100%;max-height:100%;"></div>
	<div id="pageindex">1/8</div>
	<div id='next'><img src="./images/next.png" style="max-width:100%;max-height:100%;"></div>
</div>

<!-- Overall container for all interactive widgets -->
<div id="legendcontainer">
	 <div id='fly' class="slideout-glow">Click here to follow a traditional route</div>
	 
   <div id="timeslider">	
 	    <label id='month' ></label>
  		  <input id='slider' type='range' min='0' max='3' step='1' value='0' />
   </div>
</div>
<div id="medplantwidget">
      <fieldset id="plantholder">
         <label>Estimated distribution range</label>
         <select id='medplantlayer' onchange="changeplant()"> 
            <option value='Russian Juniper'>Russian Juniper</option>
            <option value='Goat Wheat'>Goat's Wheat</option>
            <option value='Persian Walnut'>Persian Walnut</option>
         </select>
      </fieldset>
      <div id='plantinfo' class="clearfix">
          <img class="img-round" src="" onmouseover="highlightplant()" onmouseout="nohighlightplant()">           
          <span id="plantlatin"></span><br>
          <span id="plantdescription"></span><br><br>
          <div class="medplanttooltip"> Data
            <span class="medplanttooltiptext">Plant details are from <i>Medicinal Plants of Central Asia: Uzbekistan and Kyrgyzstan</i> by S. Eisenman, D. Zaurov, and L. Struwe (2013), New York, Springer. Hover over the photo to see photographer credits. Mapped distributions are my own analysis and rough estimates only.</span>
          </div>
      </div>    
</div>
<!-- slide out panel for SNA --> 
<div id="slideout" class="slideout-glow">
    <p class="sideways">Network Graphic</p>
    <div id="slideout_inner">
      <img src="images/network.png" width="100%">
    </div>
</div>
   
 <!-- Modal "About" popup -->
  <div class="modal fade" id="myModal" role="dialog">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal">&times;</button>
          <h4 class="modal-title">Why maps?</h4>
        </div>
        <div class="modal-body">
          <p>Looking at these issues from a geographic perspective help us understand that our environment shapes how we act. Differences in our environments mean that each place should have solutions that are adapted to its context, rather than a single standard. As the effects of climate change impact our communities differently and more acutely, our decision-making process needs to become more responsive, flexible, and transparent. This research was meant to demonstrate how showing localized practices, which varies from community to community, can inform environmental policies to be more responsive to different realities on the ground. </p>
          <br>
          <img src="images/about.jpg" align="right" width="50%">

          <p>Understanding that practices and beliefs are influenced by the environment around us helps dispel the "weirdness" of unfamiliar beliefs. A person living in mountainous British Columbia may have more things in common than expected with a mountain shepherd in Kyrgyzstan! As a Chinese-Canadian who speaks French, Russian, and bits of Nepali, I hope to support a pluralistic view of the world where differences should be celebrated as things that make us stronger. And as experts of the area you live in and its uniqueness, your voice becomes very important in sharing these differences. Open-access mapping platforms like <a href="http://www.openstreetmap.org/" target="_blank">Open Street Map</a> give everyone with an Internet connection a way to shape how your neighbourhood is represented.</p>
          <br>

          <p>This research was done as part of a Masters program at Carleton University, Canada. The Mountain Societies Research Institute of the University of Central Asia (headquartered in Bishkek, Kyrgyzstan) provided invaluable support as a host organization. Any comments and questions are welcome at <a href="mailto:jasonnaryn@gmail.com?Subject=iAM%20Magazine%20Map%20Feedback" target="_top">jasonnaryn@gmail.com</a></p>  
        </div>
      </div>
    </div>
  </div>
<script>
	
mapboxgl.accessToken = 'pk.eyJ1IjoibWFkc2tpaWVyIiwiYSI6ImNpb2ZnaXVteTAwM3p2cGo3aHhqYnBkbWMifQ.cEswY6uB1-saGXwbS82DWA';
var map = new mapboxgl.Map({
    style: 'mapbox://styles/mapbox/bright-v9',
    center: [75.079,41.655], 
    zoom: 1.99,
    pitch: 45,
    bearing: 0,
    //bearing: -17.6
    hash: true,
    container: 'map'
});

//coords for pasture migration route
  origin = [ 76.529977533567489, 41.503443869772582 ];
  destination = [ 77.196023676052903, 41.477726778523653 ];
  var counter = 0;
  var arc = [];
  var route = {
    "type": "FeatureCollection",
    "features": [{
        "type": "Feature",
        "geometry": {
            "type": "LineString",
            "coordinates": [origin, destination
            ]
        }
    }]
  };
 /* var pasturepoint = {
    "type": "FeatureCollection",
    "features": [{
        "type": "Feature",
        "geometry": {
            "type": "Point",
            "coordinates": origin
        }
    }]
  };*/

//index counter for number of medplant options in dropdown selector
var plantcount = medplantlayer.length;


//categories for time slider
var months = [
    'Winter',
    'Spring',
    'Summer',
    'Fall'
];

var image = document.getElementById('feature-photo');
var title = document.getElementById('feature-title');
var description = document.getElementById('feature-content');

var plantspecs =[
  {
    "value":"Russian Juniper",
    "image":"./images/russian_juniper2.jpg",
    "caption":"Photo by Vojtech Zavadil (own work), Wikimedia Commons",
    "latinname":"Juniperus semiglobosa Regel",
    "description":"A common shrub found around dry and stony slopes, its berries are traditionally consumed to improve digestion and to disinfect the urinary system. Essential oils taken from the needles and berries are used to treat skin diseases. Russian juniper is used by contemporary medicine by taking the fruit and making a tincture (dissolving it in alcohol) to treat rheumatism and gout."
  },
  {
    "value":"Goat Wheat",
    "image":"./images/goat_wheat2.jpg",
    "caption":"Photo by by Krzysztof Ziarnek (own work), Wikimedia Commons",
    "latinname":"Atraphaxis spinosa L.",
    "description":"This shrub flowers in May and June and is found in stony slopes in lower mountain areas. The leaves have been found to contain alkaloids and tannins. Traditional practice is to boil the leaves and flowers together to treat fever."
  },
  {
    "value":"Persian Walnut",
    "image":"./images/persian_walnut2.jpg",
    "caption":"Photo by Bohringer Friedrich (own work), Wikimedia Commons",
    "latinname":"Juglans regia L.",
    "description":"Growing as individual trees or small groups, this species of walnut tree is found by mountain river banks. The walnuts are boiled and the liquid is drunk to treat cardiac diseases (high blood pressure), and to rinse the mouth against gum disease. An ointment is made from the juice of the fruit husk to treat ulcers and skin diseases like eczema. The bark of the roots are used to create a very mild laxative."
  }
];
            document.getElementById("plantlatin").textContent = plantspecs[0].latinname;
            document.getElementById("plantdescription").textContent = plantspecs[0].description;
            plantinfo.getElementsByTagName("img")[0].src = plantspecs[0].image;
            plantinfo.getElementsByTagName("img")[0].title = plantspecs[0].caption;
var locations = [
  {
    	"id":"1",
    	"image":"<img src=\'./images/welcome2.jpg\' title=\'Many Kyrgyz learn how to ride a horse as young children. Horses are a common form of transportation in rural regions and also represent wealth. Photo by Jason Wong\'style=\'padding:10px\'>",
    	"title":"Welcome to Kyrgyzstan",
    	"description":"Located in Central Asia, Kyrgyzstan is a young democracy with a proud nomadic tradition. Kyrgyzstan was part of the Soviet Union until its collapse in 1991. Since then, Kyrgyzstan has emerged as a democratic state now establishing its own environmental protection policies. To promote the design of policies specifically suited to Kyrgyzstan rather than holdovers from the Soviet Union, I used open-source mapping to publish traditional practices. I hypothesized that providing a platform for local people to share their traditional expertise would show the many different ways ecosystems are used. In turn, this could help guide government policies to be more flexible and effective.",
    	"camera": {
    		center:[78.1,44.6],
    		zoom:1.8,
    		pitch:15,
        bearing:0
    	}
    }
	,{
    	"id":"2",
    	"image":"<img src=\'./images/yurt3.jpg\' title=\'In Song Kul, herders set up yurts such as these as their home in the mountains for the summer. Photo by Jason Wong\' style=\'padding:10px\'>",
    	"title":"Semi-nomadism in Naryn",
    	"description":"In provinces like Naryn where over 90% of the land is mountainous, people rely on herding animals as their main livelihood. Zoom in closely on the map to see the rise and fall of the land, with steep hills carved by valleys and rivers. Families travel with their yurts (traditional portable wood and felt homes) to graze their sheep, cows, and horses in higher pastures in summer, returning in winter to their towns. Aside from herding, pasture users pursue a range of activities such as making cheese products to increase their income. Click on a province to see its major sectors of employment. <br><br>After consulting community members, our project focused on the three topics of pasture management, ecological monitoring, and medicinal plants.",
    	"camera": {
    		center:[ 72.539,41.043],
    		zoom:5.76,
    		pitch:50
    	}
    }
    ,{
    	"id":"3",
    	"image":"<img src=\'./images/basemapping2.jpg\' title=\'Our team introduces place mapping with pasture users in Ardakty pasture, Naryn. Photo by Jason Wong\' style=\'padding:10px\'>",
    	"title":"Starting with Base Mapping",
    	"description":"Kyrgyzstan's Soviet legacy has imprinted a strong memory of overtly centralized government control, while other management schemes were suppressed. To get the community involved again in managing its own environment, we provided training using paper maps, smartphone apps, and town mapping excursions. Key members in Dobulu and Eki-Naryn learned how to upload map updates onto Open Street Map, a Wikipedia-style platform for mapping. Our goal was to show community members they could quickly make changes to the online maps of their towns with easy-to-learn tools. With an understanding of basic mapping, we turned our attention to learning about local-level adaptations that could improve existing policies.", 
      "camera": {
    		center:[76.1293,41.4427],
    		zoom:9.61,
    		pitch:30
    	}
    }		
    ,{
   		 "id":"4",
   		 "image":"<img src=\'./images/board_game2.jpg\' title=\'Mapping distinct features is difficult in the rolling high pastures. Instead, our team uses a custom board game to explain different herding practices and their geographic implications. Photo by Nadira Degembaeva\' style=\'padding:10px\'>",
    	"title":"Storytelling with Web Maps",
    	"description":"Using participatory mapping and interviews, we spoke with community members about how they worked with their local environment. Our participants ranged from school children to pensioners, herders to national park officials. Hover over the tab to the right to see the gender representation amongst our research participants, by group. Each dot represents a person, and each line shows which group that person belongs to. Poor representation of any gender can lead to serious knowledge gaps about how an environment is used. <br><br><p>We created a web atlas to share people's stories and to show different views of the same land. Based on the practices our participants shared, we identified several ways in which traditional ways could support official government policy.",
    	"camera": {
    		center:[76.2495,41.4897],
    		zoom:10,
    		pitch:30,
        bearing:0
    	}
    }
    ,{
       "id":"5",
       "image":"<img src=\'./images/highpasture2.jpg\' title=\'A park ranger of Salkyn Tor park shows a little-used path while monitoring the park and nearby pastures. Photo by Jason Wong\' style=\'padding:10px\'>",
      "title":"High Pasture Migration Routes",
      "description":"Herders tend to intensively use pastures near their villages because they are easier to reach, the roads to access these pastures are in better condition, and their yurts are more accessible to traders looking to buy milk products or to sell simple household goods such as soap. As a result, these pastures are often overgrazed. Interviewing elder herders, we mapped traditional routes across several remote pastures that have fallen into disrepair since Soviet times. Supporting these traditional routes could relieve pressure from overused nearby pastures. Our participants emphasized rebuilding drivable roads to the government to make remote pastures more accessible.",
      "camera": {
        center:[76.7752, 41.5044],
        zoom:9.42,
        pitch:40
      }
    }
    ,{
       "id":"6",
       "image":"<img src=\'./images/monitoring2.jpg\' title=\'Eki-Naryn village faces very long winters and correctly predicting the change between seasons allows residents to prepare their animals and homes for the coming snow. Photo by Jason Wong\' style=\'padding:10px\'>",
      "title":"Ecological Monitoring",
      "description":"The Soviet Union used centrally determined dates to coordinate its massive infrastructure. Since its collapse, Naryn residents have returned to traditional ways of forecasting the weather. Naryn is infamous for being the coldest province in Kyrgyzstan, with some villages experiencing 5 months of winter. Monitoring signs such as the movement of wild animals is a skill honed from years of experience and gives the observer a low-tech way to predict the weather. Use the slider below to see both local methods and previously government-controlled events.  <br><br>Consider the benefits of accessible, local methods against how generalizable and accurate they are. How can local methods be integrated into national environmental policies?",
      "camera": {
        center:[76.1493, 41.4537],
        zoom:8.86,
        pitch:44,
        bearing:0
      }
    }
    ,{
       "id":"7",
       "image":"<img src=\'./images/medplants2.jpg\' title=\'Collecting juniper in Keng Sas pasture is a common practice. The juniper will be burnt in homes to spiritually cleanse them for special occasions. Photo by Jason Wong\' style=\'padding:10px\'>",
      "title":"Cataloguing Medicinal Plants",
      "description":"Many medicinal plants are encountered in the wild, but few among the younger generation know how to identify and store them properly. By interviewing elders and reviewing their collections, we have begun an online platform to list plants, their traditional names, the terrain they are found in, and their distinguishing features. A public plant catalog can also help build dialogue between herders in the field and botanical experts in the capital of Bishkek. Our web atlas allows both sides to log on, add plants, and write recommendations or questions for each plant. Use the selector below to view estimates of where some medicinal plants can be found",
      "camera": {
        center:[73.723, 40.125],
        zoom:6.49,
        pitch:37
      }
    }
    ,{
       "id":"8",
       "image":"<img src=\'./images/sdg17-2.jpg\' title=\'SDG17 includes a focus on capacity-building and providing basic data such as censuses to inform development. Photo from United Nations \' style=\'padding:10px\'>",
      "title":"A push towards Sustainable Development Goal 17: A sustainable development knowledge platform",
      "description":"<a href='https://sustainabledevelopment.un.org/sdg17' target='_blank'>SDG 17</a> aims to rethink how development should be done. Rather than taking policies from developed countries and applying them to developing countries, SDG 17 pushes for an equal partnership and dialogue between both sides. A critical part of this is making open data available, and to acknowledge traditional knowledge as valid. This project joins the growing community of open data efforts in Kyrgyzstan to present different perspectives and priorities on the ground. To learn more about this philosophy, click on 'About' in the top-right corner.",
      "camera": {
        center:[74.851, 41.91],
        zoom:5.67,
        pitch:37
      }
    }
    ];
 
//stops along migration tour
var flyspots = [{"start":[76.529977533567489, 41.503443869772582], "zoom":13.49, "bearing":91.9, "speed":2.5, "curve":1, "pitch":50}
                ,{"start":[76.7222382757285, 41.494186893012383], "zoom":13.49, "bearing":91.9, "speed":1, "curve":1, "pitch":60}
                ,{"start":[76.917245599919497, 41.536346848537995], "zoom":13.49, "bearing":75.1, "speed":0.07, "curve":0.1,"pitch":60}
                ,{"start":[77.054574701462812, 41.521953853738246], "zoom":13.49, "bearing":98.3, "speed":0.18, "curve":0.1,"pitch":60}
                ,{"start":[77.069680902633138, 41.473611096546307], "zoom":13.49, "bearing":167.1, "speed":0.18, "curve":0.1,"pitch":60}
                ,{"start":[77.1751, 41.4882], "zoom":12.31, "bearing":80, "speed":3, "curve":0.5,"pitch":22}
];
//function to fly to points along migration tour
var flyindex = 0;
document.getElementById('fly').addEventListener('click', function() {
  if(flyindex!=flyspots.length){
    document.getElementById("fly").innerHTML = "Continue";
    map.flyTo({
        
        // These options control the ending camera position: centered at
        // the target, at zoom level 9, and north up.
        center: flyspots[flyindex].start,
        zoom: flyspots[flyindex].zoom,
        bearing: flyspots[flyindex].bearing,

        // These options control the flight curve, making it move
        // slowly and zoom out almost completely before starting
        // to pan.
        speed: flyspots[flyindex].speed, // make the flying slow
        curve: flyspots[flyindex].curve, // change the speed at which it zooms out
        pitch: flyspots[flyindex].pitch,
        // This can be any easing function: it takes a number between
        // 0 and 1 and returns another number between 0 and 1.
        easing: function (t) {
            return t;
        }
    });
  flyindex = flyindex + 1;
  } else{flyindex = 0;
    document.getElementById("fly").innerHTML = "Start again";
    //pasturepoint.features[0].geometry.coordinates = origin;
    //map.getSource("pasturepoint").setData(pasturepoint);
    //counter=0;
  }
});

  

//function to filter eco_monitoring features by month
function filterBy(month) {

    var filters = ['==', 'time', month];
    map.setFilter('eco_monitoring', filters);

    // Set the label to the month
    document.getElementById('month').textContent = months[month];
}
//function to make the camera pan to the next slide    
function playback(index) {
    image.innerHTML = locations[index].image;
    title.textContent = locations[index].title;
    description.innerHTML = locations[index].description;
    // Animate the map position based on camera properties
    map.flyTo(locations[index].camera);
}
// Toggle visible layers
var toggleableLayerIds = ['Hillshading', 'Provinces', 'Study Sites'];

for (var i = 0; i < toggleableLayerIds.length; i++) {
    var id = toggleableLayerIds[i];
    var link = document.createElement('a');
    link.href = '#';
    link.className = '';
    link.textContent = id;
    link.clickcount = 0;

    link.onclick = function (e) {
        var clickedLayer = this.textContent; 
        e.preventDefault();
        e.stopPropagation();
        //console.log(this.clickcount = this.clickcount+2); //to offer functionality of leaving a layer active if the user explicitly clicks on it in the layer selector

        var visibility = map.getLayoutProperty(clickedLayer, 'visibility');

        if (visibility === 'visible') {
            map.setLayoutProperty(clickedLayer, 'visibility', 'none');
            this.className = '';
        } else {
            this.className = 'active';
            map.setLayoutProperty(clickedLayer, 'visibility', 'visible');
        }
    };
    
    var menulayers = document.getElementById('menu');
    menulayers.appendChild(link);
    menu.getElementsByTagName("a")[0].className='active';
}
//fade-in function (for SDG17 list). Controls how fast each individual entry fills itself in
function unfade(element) {
    var op = 0.1;  // initial opacity
    element.style.display = 'block';
    var timer = setInterval(function () {
        if (op >= 1){
            clearInterval(timer);
        }
        element.style.opacity = op;
        element.style.filter = 'alpha(opacity=' + op * 100 + ")";
        op += op * 0.05;
    }, 20);
}
//function to show different distributions of medplants
    function changeplant() {
      var p = document.getElementById("medplantlayer").value; //stores the newly selected plant in p

      for (var i = 0; i<plantcount; i++){                                     //sets all plant layers invisible
        map.setLayoutProperty(medplantlayer[i].value, 'visibility','none');
        if (plantspecs[i].value == p){
            document.getElementById("plantlatin").textContent = plantspecs[i].latinname;
            document.getElementById("plantdescription").textContent = plantspecs[i].description;
            plantinfo.getElementsByTagName("img")[0].src = plantspecs[i].image;
            plantinfo.getElementsByTagName("img")[0].title = plantspecs[i].caption;
        }
      }
      map.setLayoutProperty(p, 'visibility','visible');      // sets the selected layer visible
    }
//function to highlight medplant layer when hovering over its image
    function highlightplant(){
        var current = document.getElementById("medplantlayer").value + " highlight";
        map.setLayoutProperty(current, "visibility", "visible");
    }
  //function to remove highlight of medplant layer when no longer hovering over its image
    function nohighlightplant(){
        var current = document.getElementById("medplantlayer").value + " highlight";
        map.setLayoutProperty(current, "visibility", "none");
    }
   
    
map.on('load', function() {

  //add source and layer for timeslider content
  d3.json('Geospatial Data/eco_monitoring.geojson', function(err, data) {
        if (err) throw err;
        // Create a month property value based on time
        // used to filter against.
        data.features = data.features.map(function(d) {
            d.properties.month = new Date(d.properties.time).getMonth();
            return d;
        });
        map.addSource("eco_monitoring", {
            "type": "geojson",
            "data": data
        });
        //load marker icon images for eco-monitoring layer
        map.loadImage('images/animal.png',function(error,image){
          if (error) throw error;
          map.addImage("./images/animal.png", image);
        })
        map.loadImage('images/pasture.png',function(error,image){
          if (error) throw error;
          map.addImage("./images/pasture.png", image);
        })
        map.loadImage('images/water.png',function(error,image){
          if (error) throw error;
          map.addImage("./images/water.png", image);
        })
        map.loadImage('images/soviet.png',function(error,image){
          if (error) throw error;
          map.addImage("./images/soviet.png", image);
        })
        map.loadImage('images/plant.png',function(error,image){
          if (error) throw error;
          map.addImage("./images/plant.png", image);
        })
        map.loadImage('images/rangers.png',function(error,image){
          if (error) throw error;
          map.addImage("./images/rangers.png", image);
        })
        map.loadImage('images/townevent.png',function(error,image){
          if (error) throw error;
          map.addImage("./images/townevent.png", image);
        })
        map.addLayer({
            "id": "eco_monitoring",
            "type": "symbol",
            "source": "eco_monitoring",
            "layout":{
              "icon-image": ["get", "icon"],
              "icon-size":0.1,   
              "visibility":"none",     
              "icon-allow-overlap":true
            }  
          });
        // Set time slider filter to first season
        // 0 = Winter
        filterBy(0);
        document.getElementById('slider').addEventListener('input', function(e) {
            var month = parseInt(e.target.value, 10);
            filterBy(month);
        });
  });
  map.addSource('dem', {
        "type": "raster-dem",
        "url": "mapbox://mapbox.terrain-rgb"
  });
   map.addSource('contours', {
        type: 'vector',
        url: 'mapbox://mapbox.mapbox-terrain-v2'
    });
	//Load external GeoJSON files
	map.addSource("ussr_with_KG", {
            "type": "geojson",
            "data": "Geospatial Data/ussr_with_KG.geojson"
  });
  map.addSource("before_after_osm", {
            "type": "geojson",
            "data": "Geospatial Data/before_after_osm.geojson"
  });
  map.addSource("Provinces", {
            "type": "geojson",
            "data": "Geospatial Data/kg_provinces.geojson"
        });
  map.addSource("pasture_POI", {
            "type": "geojson",
            "data": "Geospatial Data/pasture_POI_test.geojson"
        });
  
  map.addSource('pasture_route', {
   "type": 'geojson',
   'data': 'Geospatial Data/pasture_route.geojson'
  });
 
  /*map.addSource('pasturepoint', {
        "type": "geojson",
        "data": pasturepoint
    });
   
  map.addLayer({
        "id": "pasturepoint",
        "source": "pasturepoint",
        "type": "symbol",
        "layout": {
            "icon-allow-overlap": true,
            "icon-size":5,
            "icon-image":"airport-15"
        }
    });*/
   
  map.addSource("Russian Juniper", {
            "type": "geojson",
            "data": "Geospatial Data/medplants.russianJuniper.geojson"
  });
  map.addSource("Goat Wheat", {
            "type": "geojson",
            "data": "Geospatial Data/medplants.goatwheat.geojson"
  });
  map.addSource("Persian Walnut", {
            "type": "geojson",
            "data": "Geospatial Data/medplants.persianwalnut.geojson"
  });
  var layers = map.getStyle().layers;
    // Find the index of the first symbol layer in the map style
    var labelLayerId;
    for (var i = 0; i < layers.length; i++) {
        if (layers[i].type === 'symbol' && layers[i].layout['text-field']) {
            labelLayerId = layers[i].id;
            break;
        }
    }
	
	// Add zoom and rotation controls to the map.
	map.addControl(new mapboxgl.NavigationControl());
  
    // Add layers
    map.addLayer({
            "id": "USSR-KG",
            "type": "fill",
            "source": "ussr_with_KG",
            'paint': {
              'fill-color': {
                'type':'identity',
                'property':'color'
              }
              ,'fill-opacity': 0.5
            }  
        },labelLayerId);
    //hover state for USSR-KG polygons
    map.addLayer({
            "id": "USSR-KG-hover",
            "type": "fill",
            "source": "ussr_with_KG",
            'paint': {
              'fill-color': {
                'type':'identity',
                'property':'color'
              }
              ,'fill-opacity': 0.8
            },
            'layout': {
              'visibility':'none'
            }  
        },labelLayerId);

    map.addLayer({
            "id": "Provinces",
            "type": "fill",
            "source": "Provinces",
            'paint': {
              'fill-color': {
                'type':'identity',
                'property':'color'
              }
              ,'fill-opacity': 0.6
              ,'fill-outline-color':"#ffff00"
            },
            'layout': {
              'visibility':'none'
            }  
        },labelLayerId);
     map.addLayer({
        'id': 'contours',
        'type': 'line',
        'source': 'contours',
        'source-layer': 'contour',
        'layout': {
            'visibility': 'visible',
            'line-join': 'round',
            'line-cap': 'round',
            'visibility':'none'
        },
        'paint': {
            'line-color': '#877b59',
            'line-width': 1
        }
    });
    //hover state for Provinces
    map.addLayer({
            "id": "Provinces-hover",
            "type": "fill",
            "source": "Provinces",
            'paint': {
              'fill-color': {
                'type':'identity',
                'property':'color'
              }
              ,'fill-opacity': 0.8
              ,'fill-outline-color':"#ffff00"
            },
            'layout': {
              'visibility':'none'
            }  
        },labelLayerId);
    
    map.addLayer({
            "id": "pasture_route"
            ,"type": "line"
            ,"source": "pasture_route"
            ,"paint":{
              "line-color":{
                'type':'identity',
                'property':'color'
              },
              'line-width': 5
            } 
            ,"layout":{"visibility":"visible","line-cap":"round", "line-join":"round"}
    });
    //generate curved coordinates for pasture route
    d3.json('Geospatial Data/pasture_route.geojson', function(data) {
      var linehold = data.features[0].geometry.coordinates[0];
      turfline = turf.lineString(linehold);
      var curved = turf.bezierSpline(turfline);
      map.getSource("pasture_route").setData(curved);
      route.features[0].geometry.coordinates = curved; //need to pass out this variable curved!!!
      map.setLayoutProperty("pasture_route", "visibility", "none");
    }); 

    map.addLayer({
        "id": "Hillshading",
        "source": "dem",
        "type": "hillshade"
    });
    map.addLayer({
            "id": "Russian Juniper",
            "type": "fill",
            "source": "Russian Juniper",
            'paint': {
              'fill-color': {
                'type':'identity',
                'property':'color'
              }
              ,'fill-opacity': 0.9
            },
            'layout': {
              'visibility':'none'
            }  
        },labelLayerId);
    map.addLayer({
            "id": "Russian Juniper highlight",
            "type": "fill",
            "source": "Russian Juniper",
            'paint': {
              "fill-outline-color": "#ff9",
              'fill-color': "#f70" 
              ,'fill-opacity': 1
            },
            'layout': {
              'visibility':'none'
            }  
        });
    map.addLayer({
            "id": "Goat Wheat",
            "type": "fill",
            "source": "Goat Wheat",
            'paint': {
              'fill-color': {
                'type':'identity',
                'property':'color'
              }
              ,'fill-opacity': 0.9
            },
            'layout': {
              'visibility':'none'
            }  
        },labelLayerId);
    map.addLayer({
            "id": "Goat Wheat highlight",
            "type": "fill",
            "source": "Goat Wheat",
            'paint': {
              "fill-outline-color": "#ff9",
              'fill-color': "#f70" 
              ,'fill-opacity': 1
            },
            'layout': {
              'visibility':'none'
            }  
        });
    map.addLayer({
            "id": "Persian Walnut",
            "type": "fill",
            "source": "Persian Walnut",
            'paint': {
              'fill-color': {
                'type':'identity',
                'property':'color'
              }
              ,'fill-opacity': 0.9
            },
            'layout': {
              'visibility':'none'
            }  
        },labelLayerId);
    map.addLayer({
            "id": "Persian Walnut highlight",
            "type": "fill",
            "source": "Persian Walnut",
            'paint': {
              "fill-outline-color": "#ff9",
              'fill-color': "#f70" 
              ,'fill-opacity': 1
            },
            'layout': {
              'visibility':'none'
            }  
        });

      
   //loads marker images for the before_after_osm layer
   map.loadImage('images/village.png',function(error,image){
      if (error) throw error;
      map.addImage("village", image);
    
   map.addLayer({
            "id": "Study Sites",
            "type": "symbol",
            "source": "before_after_osm",
            "layout":{
              "icon-image": "village",
              "icon-size":0.07,
              "icon-allow-overlap":true,
              "visibility":"none"
            }  
        });
   })
   map.loadImage('images/rangers.png',function(error,image){
      if (error) throw error;
      map.addImage("rangers", image);
    
   map.addLayer({
            "id": "pasture_POI",
            "type": "symbol",
            "source": "pasture_POI",
            "layout":{
              "icon-image": "rangers",
              "icon-size":0.07,
              "visibility":"none"
            }  
        });
   })
    
    // Create a popup, but don't add it to the map yet.
    var popup = new mapboxgl.Popup({
        closeButton: true,
        closeOnClick: false
    });
    var popup_pastures = new mapboxgl.Popup({
        closeButton: true,
        closeOnClick: true
    });

    //hovering for USSR-KG Polygons
    map.on("mousemove", "USSR-KG", function(e) {
        map.setLayoutProperty('USSR-KG-hover', 'visibility','visible');
        map.setFilter("USSR-KG-hover", ["==", "NAME", e.features[0].properties.NAME]);
    });
    // Reset the state-fills-hover layer's filter when the mouse leaves the layer.
    map.on("mouseleave", "USSR-KG", function() {
    	map.setLayoutProperty('USSR-KG-hover', 'visibility','none')
        map.setFilter("USSR-KG-hover", ["==", "NAME", ""]);
    });

    //pop ups for before-after markers
    map.on('click', 'Study Sites', function(e) {
        // Change the cursor style as a UI indicator.
        map.getCanvas().style.cursor = 'pointer';
        // Populate the line popup and set its coordinates based on the first coordinates of the line
        if (e.features[0].properties.image == null){
            popup.setLngLat(e.lngLat)
            .setHTML('<h4>'+ e.features[0].properties.Name + '</h4>' 
              + e.features[0].properties.description + '<br>'
              + e.features[0].properties.caption
              )
            .addTo(map);
        } else {
        popup.setLngLat(e.lngLat)
            .setHTML('<h4>'+ e.features[0].properties.Name + '</h4>' 
              + e.features[0].properties.description
              + '<br> <object data="' + e.features[0].properties.image+ '" type ="image/jpg"></object> <br>'
              + "<i>" + e.features[0].properties.caption + "</i>"
              )
            .addTo(map);
          }
            map.flyTo({center: [e.features[0].geometry.coordinates[0],e.features[0].geometry.coordinates[1]]});
    });


    //function to animate the moving dot for pasture slide
    /*function animate(){
      
        pasturepoint.features[0].geometry.coordinates = route.features[0].geometry.coordinates[counter];
        map.getSource("pasturepoint").setData(pasturepoint);
        if (pasturepoint.features[0].geometry.coordinates[0] !== destination[0]) {
              requestAnimationFrame(animate);
          }
        counter = counter + 1;
    }*/


    //pop ups for KG Provinces
    map.on("mousemove", "Provinces", function(e) {
        map.setLayoutProperty('Provinces-hover', 'visibility','visible')
        map.setFilter("Provinces-hover", ["==", "NAME_1", e.features[0].properties.NAME_1]);
        
    });
    // Reset the state-fills-hover layer's filter when the mouse leaves the layer.
    map.on("mouseleave", "Provinces", function() {
    	map.setLayoutProperty('Provinces-hover', 'visibility','none')
        map.setFilter("Provinces-hover", ["==", "NAME_1", ""]);
    });

    //pop ups for pasture route POIs
    map.on("mousemove", "pasture_POI", function(e) {
         map.getCanvas().style.cursor = 'pointer';
         popup_pastures.setLngLat(e.lngLat)
         .setHTML("<h4>" + e.features[0].properties.name + "</h4>" + e.features[0].properties.image + e.features[0].properties.descript)
         .addTo(map);
    });

    //close popup when the mouse is no longer hovering.
    map.on("mouseleave", "pasture_POI", function() {
      map.getCanvas().style.cursor = '';
        popup.remove();
    });

    map.on('click', 'Provinces', function(e) {
        map.getCanvas().style.cursor = 'pointer';
        // Populate the line popup and set its coordinates based on the first coordinates of the line
        popup.setLngLat(e.lngLat)
            .setHTML('<h4>'+ e.features[0].properties.VARNAME_1 + ' ' + e.features[0].properties.ENGTYPE_1 + '</h4>' 
              + '<b>Top eight livelihood activities (thousands employed, 2016)</b> <br><i>Click on each legend item\'s box to toggle it on or off.<div id="chart"></div> Data courtesy of the National Statistical Committee of the Kyrgyz Republic (www.stat.kg)</i>'
            )
            .addTo(map);
            map.flyTo({center: [e.lngLat.lng,e.lngLat.lat]});
            //create pie charts
         var pieindex = e.features[0].properties.url;
         (function(d3) {
        'use strict';
        
        var $container = $('#chart'),
        width = $container.width(),
        height = $container.height(),
         radius = Math.min(width, height) / 2,
         donutWidth = 75,                            
        legendRectSize = 14,                                  
        legendSpacing = 4;       
        //var width = "100%";
        //var height = "100%";
         
        

        var color = d3.scaleOrdinal(d3.schemeCategory10);

        var svg = d3.select('#chart')
          .append('svg')
          .attr('width', width)
          .attr('height', height)
          //.attr("viewBox" , "0 0 360 360")
          .attr('viewBox','0 0 '+ Math.min(width,height)+' '+Math.min(width,height))
          .attr("preserveAspectRatio", "xMinYMin ")
          .append('g')
          .attr("transform", "translate(" + Math.min(width,height) / 2 + "," + Math.min(width,height) / 2 + ")");
          //.attr('transform', 'translate(' + (width / 2) + ',' + (height / 2) + ')');

        var arc = d3.arc()
          .innerRadius(radius - donutWidth)           
          .outerRadius(radius);

        var pie = d3.pie()
          .value(function(d) { return d.count; })
          .sort(null);

        var tooltip = d3.select('#chart')                               // NEW
          .append('div')                                                // NEW
          .attr('class', 'tooltip');                                    // NEW

        tooltip.append('div')                                           // NEW
          .attr('class', 'label');                                      // NEW

        tooltip.append('div')                                           // NEW
          .attr('class', 'count');                                      // NEW

        tooltip.append('div')                                           // NEW
          .attr('class', 'percent');                                    // NEW

        d3.csv(pieindex, function(error, dataset) {  // NEW
        dataset.forEach(function(d) {                    
         d.count = +d.count;                            
         d.enabled = true;                               
        });                                              

        var path = svg.selectAll('path')
          .data(pie(dataset))
          .enter()
          .append('path')
          .attr('d', arc)
          .attr('fill', function(d) {
            return color(d.data.label);
          })
          .each(function(d) { this._current = d; });                // NEW

        path.on('mouseover', function(d) {                            // NEW
            var total = d3.sum(dataset.map(function(d) {                // NEW
              return (d.enabled) ? d.count : 0;
            }));                                                        // NEW
            var percent = Math.round(1000 * d.data.count / total) / 10; // NEW
            tooltip.select('.label').html(d.data.label);                // NEW
            tooltip.select('.count').html(d.data.count + " thousand");                // NEW
            tooltip.select('.percent').html(percent + '%');             // NEW
            tooltip.style('display', 'block');                          // NEW
          });                                                           // NEW

          path.on('mouseout', function() {                              // NEW
            tooltip.style('display', 'none');                           // NEW
          });                                                           // NEW

          
          path.on('mousemove', function(d) {                            // NEW
            tooltip.style('top', (d3.event.layerY + 10) + 'px')         // NEW
              .style('left', (d3.event.layerX + 10) + 'px');            // NEW
          });                                                           // NEW
          

        var legend = svg.selectAll('.legend')                     // NEW
          .data(color.domain())                                   // NEW
          .enter()                                                // NEW
          .append('g')                                            // NEW
          .attr('class', 'legend')                                // NEW
          .attr('transform', function(d, i) {                     // NEW
            var height = legendRectSize + legendSpacing;          // NEW
            var offset =  height * color.domain().length / 2;     // NEW
            var horz = -5 * legendRectSize;                       // NEW
            var vert = i * height - offset;                       // NEW
            return 'translate(' + horz + ',' + vert + ')';        // NEW
          });                                                     // NEW

        legend.append('rect')                                     // NEW
          .attr('width', legendRectSize)                          // NEW
          .attr('height', legendRectSize)                         // NEW
          .style('fill', color)                                   // NEW
          .style('stroke', color)                                // NEW
          .on('click', function(label) {                            // NEW
              var rect = d3.select(this);                             // NEW
              var enabled = true;                                     // NEW
              var totalEnabled = d3.sum(dataset.map(function(d) {     // NEW
                return (d.enabled) ? 1 : 0;                           // NEW
              }));                                                    // NEW

              if (rect.attr('class') === 'disabled') {                // NEW
                rect.attr('class', '');                               // NEW
              } else {                                                // NEW
                if (totalEnabled < 2) return;                         // NEW
                rect.attr('class', 'disabled');                       // NEW
                enabled = false;                                      // NEW
              }                                                       // NEW

              pie.value(function(d) {                                 // NEW
                if (d.label === label) d.enabled = enabled;           // NEW
                return (d.enabled) ? d.count : 0;                     // NEW
              });                                                     // NEW

              path = path.data(pie(dataset));                         // NEW

              path.transition()                                       // NEW
                .duration(750)                                        // NEW
                .attrTween('d', function(d) {                         // NEW
                  var interpolate = d3.interpolate(this._current, d); // NEW
                  this._current = interpolate(0);                     // NEW
                  return function(t) {                                // NEW
                    return arc(interpolate(t));                       // NEW
                  };                                                  // NEW
                });                                                   // NEW
            });                                                       // NEW

        legend.append('text')                                     // NEW
          .attr('x', legendRectSize + legendSpacing)              // NEW
          .attr('y', legendRectSize - legendSpacing)              // NEW
          .text(function(d) { return d; });                       // NEW
        });                                                // NEW

      })(window.d3)   

 
    });

    //pop ups for timeslider eco monitoring
    map.on('click', 'eco_monitoring', function(e) {
        // Change the cursor style as a UI indicator.
        map.getCanvas().style.cursor = 'pointer';
        // Populate the line popup and set its coordinates based on the first coordinates of the line
        popup.setLngLat(e.lngLat)
            .setHTML(
              e.features[0].properties.description
            )
            .addTo(map);
            map.flyTo({center: [e.features[0].geometry.coordinates[0],e.features[0].geometry.coordinates[1]]});
    });
    
    //Pans the camera to the next or previous location on "locations" when the "next" button is clicked
	index = 0;
  liCount = sdg17.getElementsByTagName("li").length;//counts how many line entries there are for SDG17 table
  var p = document.getElementById("medplantlayer").value; // variable to hold the value of the medplant selected in slide 7
    document.getElementById('next').addEventListener('click', function(event) {
        index = (index + 1 === locations.length) ? 0 : index + 1;
            playback(index);
            //reset migration tour buttons
            if (index!=4){
            flyindex =0;
            document.getElementById("fly").innerHTML = "Click here to follow a traditional route";
            fly.style.display="none";
            } else {
              fly.style.display="block";
            }
            //closes all previously opened popups
            popup.remove();
            popup_pastures.remove();
            //turns on or off layers depending on what slide you are currently viewing while pressing the forward-slide button
            t0 = (index === 0) ? map.setLayoutProperty('USSR-KG', 'visibility','visible') : map.setLayoutProperty('USSR-KG', 'visibility','none');
            if (index==1){
                map.setLayoutProperty('Provinces', 'visibility','visible');
                menu.getElementsByTagName("a")[1].className='active';
            } else{
                map.setLayoutProperty('Provinces', 'visibility','none');
            }
            t2 = (index === 2) ? map.setLayoutProperty('Study Sites', 'visibility','visible') : map.setLayoutProperty('Study Sites', 'visibility','none');
            t3 = (index === 3) ? slideout.style.display="block" : slideout.style.display="none";
            if (index==4) {
              map.setLayoutProperty('pasture_route', 'visibility','visible');
              map.setLayoutProperty('pasture_POI', 'visibility', 'visible');
              map.setLayoutProperty('contours', 'visibility', 'visible');
            } else {
              map.setLayoutProperty('pasture_route', 'visibility','none');
              map.setLayoutProperty('pasture_POI', 'visibility', 'none');
              map.setLayoutProperty('contours', 'visibility', 'none');
            } 
            //t4 = (index === 4) ? animate(counter) : counter = 0;
            t5 = (index === 5) ? map.setLayoutProperty('eco_monitoring', 'visibility','visible') : map.setLayoutProperty('eco_monitoring', 'visibility','none');
            t5 = (index === 5) ? timeslider.style.display="block" : timeslider.style.display="none";
            if (index == 6) {
              medplantwidget.style.display="block";
              map.setLayoutProperty(document.getElementById("medplantlayer").value, 'visibility','visible');
            } else {
              medplantwidget.style.display="none";
              for (var i = 0; i<plantcount; i++){
                map.setLayoutProperty(medplantlayer[i].value, 'visibility','none');
              }
            }

            if (index == 7){
              sdg17.style.display="block";
              //fade in list items for SDG17
              
              unfade(sdg17.getElementsByTagName("li").item(0));

              for (var i = 1; i < liCount; i++){ //fade in each line entry one at a time. Controls the speed that the entire set of rows gets faded
                (function(i) {
                  setTimeout(function(){
                    unfade(sdg17.getElementsByTagName("li").item(i));
                  },i*500)
                })(i);
              }
            } else {
              sdg17.style.display="none";
              for (var i = 0; i < liCount; i++){
                sdg17.getElementsByTagName("li")[i].style.opacity=0;
              }
            }
            activecheck = (map.getLayoutProperty("Provinces", 'visibility') === "visible" ) ? menu.getElementsByTagName("a")[1].className='active' : menu.getElementsByTagName("a")[1].className='';
            activecheck = (map.getLayoutProperty("Study Sites", 'visibility') === "visible" ) ? menu.getElementsByTagName("a")[2].className='active' : menu.getElementsByTagName("a")[2].className='';
            document.getElementById('pageindex').textContent = locations[index].id + "/" + locations.length;

    });
    document.getElementById('previous').addEventListener('click', function(event) {
        index = (index - 1 === -1) ? locations.length-1 : index - 1;
            playback(index);
            //reset migration tour buttons
            if (index!=4){
              flyindex =0;
              document.getElementById("fly").innerHTML = "Click here to follow a traditional route";
              fly.style.display="none";
            } else {
              fly.style.display="block";
            }
            //closes all previously opened popups
            popup.remove();
            popup_pastures.remove();
            //turns on or off layers depending on what slide you are currently viewing while pressing the back-slide button
            t0 = (index === 0) ? map.setLayoutProperty('USSR-KG', 'visibility','visible') : map.setLayoutProperty('USSR-KG', 'visibility','none');
            t1 = (index === 1) ? map.setLayoutProperty('Provinces', 'visibility', 'visible') : map.setLayoutProperty('Provinces', 'visibility', 'none');
            t2 = (index === 2) ? map.setLayoutProperty('Study Sites', 'visibility','visible') : map.setLayoutProperty('Study Sites', 'visibility','none');
            t3 = (index === 3) ? slideout.style.display="block" : slideout.style.display="none";
            if (index==4) {
              map.setLayoutProperty('pasture_route', 'visibility','visible');
              map.setLayoutProperty('pasture_POI', 'visibility', 'visible');
              map.setLayoutProperty('contours', 'visibility', 'visible');
            } else {
              map.setLayoutProperty('pasture_route', 'visibility','none');
              map.setLayoutProperty('pasture_POI', 'visibility', 'none');
              map.setLayoutProperty('contours', 'visibility', 'none');
            } 
            //t4 = (index === 4) ? animate(counter) : counter = 0;
            t5 = (index === 5) ? map.setLayoutProperty('eco_monitoring', 'visibility','visible') : map.setLayoutProperty('eco_monitoring', 'visibility','none');
            t5 = (index === 5) ? timeslider.style.display="block" : timeslider.style.display="none";
            if (index == 6) {
              medplantwidget.style.display="block";
              //var p = document.getElementById("medplantlayer").value;
              map.setLayoutProperty(document.getElementById("medplantlayer").value, 'visibility','visible');
            } else {
              medplantwidget.style.display="none";
              for (var i = 0; i<plantcount; i++){
                map.setLayoutProperty(medplantlayer[i].value, 'visibility','none');
              }
            }
           // t6 = (index === 6) ? map.setLayoutProperty('medplants', 'visibility','visible') : map.setLayoutProperty('medplants', 'visibility','none');
            if (index == 7){
               sdg17.style.display="block";

              //fade in list items for SDG17
              unfade(sdg17.getElementsByTagName("li").item(0));
              for (var i = 1; i < liCount; i++){ //fade in each line entry one at a time
                (function(i) {
                  setTimeout(function(){
                    unfade(sdg17.getElementsByTagName("li").item(i));
                  },i*500)
                })(i);
              }
            } else {
              sdg17.style.display="none";
              for (var i = 0; i < liCount; i++){
                sdg17.getElementsByTagName("li")[i].style.opacity=0;
              }
            }
            activecheck = (map.getLayoutProperty("Provinces", 'visibility') === "visible" ) ? menu.getElementsByTagName("a")[1].className='active' : menu.getElementsByTagName("a")[1].className='';
            activecheck = (map.getLayoutProperty("Study Sites", 'visibility') === "visible" ) ? menu.getElementsByTagName("a")[2].className='active' : menu.getElementsByTagName("a")[2].className='';
            document.getElementById('pageindex').textContent = locations[index].id + "/" + locations.length;
    });

    // Start the playback animation for the prepared slides
    playback(index);
});
</script>
</body>
</html>
